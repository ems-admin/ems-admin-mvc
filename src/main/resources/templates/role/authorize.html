<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>角色授权</title>
    <link rel="stylesheet" href="../../static/layui-v2.6.8/layui/css/layui.css"/>
    <link rel="stylesheet" href="../../static/css/common.css"/>
</head>
<body class="body" style="padding-top: 30px;padding-left: 50px;padding-right: 50px;">
<div id="app">
    <div id="tree" style="height: 260px;"></div>
    <div class="btn-div">
        <button class="layui-btn layui-btn-sm layui-btn-primary btn-save" @click="cancel">取消</button>
        <button class="layui-btn layui-btn-sm layui-btn-normal btn-save" @click="authorize">授权</button>
    </div>
</div>
</body>
<script src="../../static/layui-v2.6.8/layui/layui.js"></script>
<script src="../../static/js/axios.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
<script src="../../static/js/http.js"></script>
<script src="../../static/js/vue3.js"></script>
<script src="../../static/js/common.js"></script>
<script>
  const app = {
    setup(){
      const state = Vue.reactive({
        roleId: '',
        menuIds: []
      })

      const getMenuTree = () => {
        get('/sys/menu/role/tree', {roleId: state.roleId}).then(res => {
          if (res.success){
            Vue.nextTick(() => {
              const tree = layui.tree
              renderTree(tree, res.data)
            })
          }
        })

      }

      const renderTree = (tree, data) => {
        tree.render({
          elem: '#tree',
          id: 'tree_id',
          data: data,
          showCheckbox: true,
          accordion: true
        })
      }

      const authorize = () => {
        Vue.nextTick(() => {
          const tree = layui.tree
          //获得选中的节点
          const checkData = tree.getChecked('tree_id')
          state.menuIds = []
          state.menuIds = getChildNodes(checkData, state.menuIds)
          post('/sys/role/menu/edit', {roleId: state.roleId, menuIds: state.menuIds}).then(res => {
            if (res.success){
              cancel()
              getMenuTree()
              successMsg(res.data)
            } else {
              errorMsg(res.msg)
            }
          })
        })
      }

      //  只获取最下级子节点，防止获取上级目录，渲染的时候会将该上级目录的所有下级目录勾选
      const getChildNodes = (treeNode, result) => {
        for (const i in treeNode) {
          if (treeNode[i].children && treeNode[i].children.length === 0){
            result.push(treeNode[i].id)
          } else {
            getChildNodes(treeNode[i].children, result)
          }
        }
        return result
      }

      const cancel = () => {
        window.parent.layer.closeAll()
      }

      return {
        state,
        getMenuTree,
        authorize,
        cancel
      }
    }
  }
  const vue = Vue.createApp(app).mount('#app')

  function getParentData(roleId){
      vue.state.roleId = roleId
      vue.getMenuTree()
  }
</script>
</html>